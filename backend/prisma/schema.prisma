// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  avatar    String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  favorites     Favorite[]
  watchHistory  WatchHistory[]
  comments      Comment[]
  commentVotes  CommentVote[]
  
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// ============================================
// MOVIE
// ============================================

model Movie {
  id               String    @id @default(uuid())
  externalId       String?   @unique // ID from external provider (TMDB, etc.)
  title            String
  originalTitle    String?   // TMDB original_title
  mediaType        MediaType @default(MOVIE) // 'movie' or 'tv'
  description      String?
  posterUrl        String?
  backdropUrl      String?
  trailerUrl       String?   // YouTube trailer URL
  releaseDate      DateTime?
  duration         Int?      // in minutes
  rating           Float?
  genres           String[]  // Array of genre names
  imdbId           String?   // IMDB identifier
  originalLanguage String?   // TMDB original_language
  provider         String    @default("tmdb") // 'tmdb', 'local', 'self-hosted'
  streamUrl        String?   // URL for streaming (when self-hosted)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  favorites    Favorite[]
  watchHistory WatchHistory[]
  
  @@map("movies")
}

enum MediaType {
  MOVIE
  TV
}

// ============================================
// FAVORITE
// ============================================

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  movieId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@map("favorites")
}

// ============================================
// WATCH HISTORY (for recommendations)
// ============================================

model WatchHistory {
  id             String   @id @default(uuid())
  userId         String
  movieId        String
  episodeNumber  Int?              // Episode number for series
  serverName     String?           // Server name for streaming
  firstWatchedAt DateTime @default(now())
  lastWatchedAt  DateTime @default(now())
  completed      Boolean  @default(false)

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId, episodeNumber])
  @@map("watch_history")
}

// ============================================
// COMMENT SYSTEM
// ============================================

model Comment {
  id        String   @id @default(uuid())
  userId    String
  movieId   String   // Store as string, no foreign key (movie might be from TMDB)
  parentId  String?
  content   String   @db.Text
  isSpoiler Boolean  @default(false)
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[]     @relation("CommentReplies")
  votes   CommentVote[]

  @@index([movieId])
  @@index([parentId])
  @@index([userId, createdAt])
  @@map("comments")
}

model CommentVote {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  voteType  VoteType
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@map("comment_votes")
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}
