generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String         @id @default(uuid())
  email        String         @unique
  password     String
  name         String?
  avatar       String?
  role         UserRole       @default(USER)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  commentVotes CommentVote[]
  comments     Comment[]
  favorites    Favorite[]
  watchHistory WatchHistory[]

  @@map("users")
}

model Movie {
  id               String         @id @default(uuid())
  externalId       String?        @unique
  title            String
  mediaType        MediaType      @default(MOVIE)
  description      String?
  posterUrl        String?
  backdropUrl      String?
  releaseDate      DateTime?
  duration         Int?
  rating           Float?
  genres           String[]
  provider         String         @default("tmdb")
  streamUrl        String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  imdbId           String?
  originalLanguage String?
  originalTitle    String?
  trailerUrl       String?
  favorites        Favorite[]
  watchHistory     WatchHistory[]

  @@map("movies")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  movieId   String
  createdAt DateTime @default(now())
  movie     Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@map("favorites")
}

model WatchHistory {
  id             String   @id @default(uuid())
  userId         String
  movieId        String
  completed      Boolean  @default(false)
  episodeNumber  Int?
  firstWatchedAt DateTime @default(now())
  lastWatchedAt  DateTime @default(now())
  serverName     String?
  movie          Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId, episodeNumber])
  @@map("watch_history")
}

model Comment {
  id        String        @id @default(uuid())
  userId    String
  movieId   String
  parentId  String?
  content   String
  isSpoiler Boolean       @default(false)
  upvotes   Int           @default(0)
  downvotes Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  votes     CommentVote[]
  parent    Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]     @relation("CommentReplies")
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([movieId])
  @@index([parentId])
  @@index([userId, createdAt])
  @@map("comments")
}

model CommentVote {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  voteType  VoteType
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@map("comment_votes")
}

enum UserRole {
  USER
  ADMIN
}

enum MediaType {
  MOVIE
  TV
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}
